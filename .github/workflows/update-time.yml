import os
import json
from datetime import datetime

# === é…ç½®åŒº ===
# 1. æ ¹ç›®å½•å’Œå­ç›®å½•è·¯å¾„
ROOT_ICON_DIR = "icon"
EMBY_ICON_DIR = "icon/emby"

# 2. åŸºç¡€ URL
BASE_URL = "https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/"
JSON_FILE = "lige-emby-icon.json"

# === æ ¸å¿ƒï¼šç»å¯¹å›ºå®šçš„ 26 ä¸ªå›¾æ ‡æ•°æ® ===
# è¿™äº›å›¾æ ‡ç›®å‰éƒ½åœ¨ icon æ ¹ç›®å½•ä¸‹
FIXED_ICONS = [
    "emby", "chinamobilemcloud", "189", "chinaunicomcloud", "123", "115", 
    "quark", "alicloud", "alidrive", "baidunetdisk", "baidunetdisk(1)", 
    "pikpak", "pCloud", "jianguoyun", "OneDrive", "OneDrive(1)", 
    "alist", "alist(1)", "OpenList", "clouddrive2", "jellyfin", 
    "xiaohuanRodelPlayer", "NAS", "NAS(1)", "NAS(2)", "qunhuiguanjia"
]

def update_json():
    final_icons = []
    
    # 1. å†™å…¥ 26 ä¸ªå›ºå®šçš„åˆ—è¡¨ï¼ˆæŒ‡å‘ icon æ ¹ç›®å½•ï¼‰
    for name in FIXED_ICONS:
        final_icons.append({
            "name": name,
            "url": f"{BASE_URL}{ROOT_ICON_DIR}/{name}.png"
        })

    # 2. åªæ‰«æ icon/emby æ–‡ä»¶å¤¹ï¼Œå¯»æ‰¾â€œé¢å¤–â€çš„å›¾æ ‡
    if os.path.exists(EMBY_ICON_DIR):
        # è·å– emby æ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰ png æ–‡ä»¶åï¼ˆä¸å¸¦åç¼€ï¼‰
        extra_files = [os.path.splitext(f)[0] for f in os.listdir(EMBY_ICON_DIR) if f.lower().endswith('.png')]
        
        # 3. å¯¹è¿™äº›é¢å¤–å›¾æ ‡è¿›è¡Œé¦–å­—æ¯ A-Z æ’åº
        extra_files.sort(key=lambda x: x.lower())
        
        # 4. å°†å®ƒä»¬æ·»åŠ åˆ°åˆ—è¡¨æœ«å°¾ï¼ˆæŒ‡å‘ icon/emby ç›®å½•ï¼‰
        for name in extra_files:
            # æ’é™¤æ‰å¯èƒ½é‡å¤å®šä¹‰çš„å›ºå®šå›¾æ ‡å
            if name not in FIXED_ICONS:
                final_icons.append({
                    "name": name,
                    "url": f"{BASE_URL}{EMBY_ICON_DIR}/{name}.png"
                })

    # 5. ç»„è£…æœ€ç»ˆ JSON ç»“æ„
    today_str = datetime.now().strftime("%y%m%d")
    data = {
        "name": "ç¦»æ­Œembyä¸“ç”¨",
        "description": f"æ— å¿æ±‚æ›´ï¼Œå›¾æ ‡åŒ…æ›´æ–°è¯·å…³æ³¨TGé¢‘é“ï¼š@ligeicon æ‚¨å½“å‰ç‰ˆæœ¬æ—¥æœŸä¸º{today_str}",
        "icons": final_icons
    }

    # 6. å†™å…¥æ–‡ä»¶å¹¶å¤„ç†è½¬ä¹‰æ–œæ  \/
    with open(JSON_FILE, 'w', encoding='utf-8') as jf:
        content = json.dumps(data, indent=2, ensure_ascii=False)
        content = content.replace("/", "\\/")
        jf.write(content)

    print(f"âœ… ä¿®æ­£å®Œæˆï¼")
    print(f"ğŸ“Œ å›ºå®šå›¾æ ‡ï¼š{len(FIXED_ICONS)} ä¸ªï¼ˆæºè‡ª icon/ï¼‰")
    print(f"ğŸ“Œ é¢å¤–å›¾æ ‡ï¼š{len(final_icons) - len(FIXED_ICONS)} ä¸ªï¼ˆæºè‡ª icon/emby/ï¼‰")

if __name__ == "__main__":
    update_json()
