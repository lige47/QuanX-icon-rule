name: Update Icons and README Time

on:
  push:
    paths:
      - 'icon/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šè¿è¡Œå­˜æ”¾åœ¨ scripts ä¸‹çš„å›¾æ ‡ JSON ç”Ÿæˆè„šæœ¬
      - name: Run Update Icons Script
        run: python scripts/update_icons.py

      # ğŸŸ¢ ç¬¬äºŒæ­¥ï¼šè®¡ç®—æ•°æ®å¹¶ä¿®æ”¹ README (ä½¿ç”¨ä½ æä¾›çš„ Python é€»è¾‘)
      - name: Calculate Data & Update README
        id: update_step
        shell: python
        run: |
          import os
          import re
          import json
          from datetime import datetime, timedelta

          # 1. è®¡ç®—åŒ—äº¬æ—¶é—´
          now_utc = datetime.utcnow()
          now_beijing = now_utc + timedelta(hours=8)
          time_std = now_beijing.strftime('%Y-%m-%d %H:%M:%S')
          time_cn = now_beijing.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')

          # 2. è¯»å– JSON è·å–å›¾æ ‡æ€»æ•°
          icon_count = 0
          try:
              with open('lige-emby-icon.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  icon_count = len(data.get('icons', []))
          except Exception as e:
              print(f"è¯»å–å›¾æ ‡æ•°å¤±è´¥: {e}")

          # 3. å†™å…¥ Github Environment
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"UPDATE_TIME_CN={time_cn}\n")
              f.write(f"ICON_COUNT={icon_count}\n")

          # 4. ä¿®æ”¹ README.md
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              pattern = r'()(.*?)()'
              replacement = f'\\1\nğŸ•’ æœ¬é¡¹ç›®æœ€è¿‘æ›´æ–°äºï¼š{time_std} (å…±è®¡ {icon_count} ä¸ªå›¾æ ‡)\n\\3'
              new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(new_content)
          except Exception as e:
              print(f"âŒ ä¿®æ”¹ README å¤±è´¥: {e}")

      # ğŸŸ¢ ç¬¬ä¸‰æ­¥ï¼šæ¨é€å˜åŠ¨åˆ° GitHub
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          if [[ -n $(git status -s) ]]; then
            git commit -m "docs: auto update time and stats [skip ci]"
            git push
          fi

      # ğŸŸ¢ ç¬¬å››æ­¥ï¼šç¼–è¾‘ Telegram æ¶ˆæ¯
      - name: Update Telegram Message
        run: |
          TOKEN="${{ secrets.TG_BOT_TOKEN }}"
          CHAT_ID="@ligeicon" # ä½ çš„é¢‘é“ ID
          MSG_ID="91"         # ä½ æä¾›çš„æ¶ˆæ¯é“¾æ¥ä¸­çš„ ID
          
          # æ„å»ºå‘é€å†…å®¹
          TEXT="ç¦»æ­Œå›¾æ ‡åº“å·²æ›´æ–°%0AğŸ•’ æ›´æ–°æ—¶é—´ï¼š${{ env.UPDATE_TIME_CN }}%0AğŸ“¦ å›¾æ ‡æ€»æ•°ï¼š${{ env.ICON_COUNT }} ä¸ª"
          
          # æ‰§è¡Œä¿®æ”¹
          curl -s -X POST "https://api.telegram.org/bot$TOKEN/editMessageText" \
            -d "chat_id=$CHAT_ID" \
            -d "message_id=$MSG_ID" \
            -d "text=$TEXT"
