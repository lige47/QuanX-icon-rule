name: Update Last Updated Time

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ•°æ®å¹¶ä¿®æ”¹ README (ä¿®å¤ä¹±ç ç‰ˆ)
      - name: Calculate Data & Update README
        id: update_step
        run: |
          python3 - <<EOF
          import os
          import re
          import datetime
          
          # 1. è®¾ç½®æ—¶åŒº (UTC+8)
          tz_offset = datetime.timedelta(hours=8)
          now = datetime.datetime.now(datetime.timezone.utc) + tz_offset
          
          # ç”Ÿæˆä¸¤ç§æ ¼å¼çš„æ—¶é—´
          time_cn = now.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S') # ç»™ Telegram ç”¨
          time_std = now.strftime('%Y-%m-%d %H:%M:%S')   # ç»™ README ç”¨

          # 2. ç»Ÿè®¡ Icon æ•°é‡
          icon_count = 0
          if os.path.exists("icon"):
              for root, dirs, files in os.walk("icon"):
                  for file in files:
                      if file.lower().endswith(".png"):
                          icon_count += 1
          
          print(f"ğŸ“Š ç»Ÿè®¡ç»“æœ: æ—¶é—´={time_std}, å›¾æ ‡æ•°={icon_count}")

          # 3. å°†å˜é‡å†™å…¥ Github Environment
          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f"UPDATE_TIME_CN={time_cn}\n")
              f.write(f"ICON_COUNT={icon_count}\n")

          # 4. ä¿®æ”¹ README.md (ä¹±ç ä¿®å¤é€»è¾‘)
          try:
              # å®šä¹‰æ ‡ç­¾å¸¸é‡
              START_TAG = "<!-- START_SECTION:update_time -->"
              END_TAG = "<!-- END_SECTION:update_time -->"
              
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              # æ­£åˆ™ï¼šåŒ¹é…æ ‡ç­¾åŠå…¶ä¸­é—´çš„æ‰€æœ‰å†…å®¹
              # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æ‹¼æ¥ regexï¼Œç¡®ä¿ç²¾å‡†åŒ¹é…
              pattern = f"{re.escape(START_TAG)}.*?{re.escape(END_TAG)}"
              
              # æ–°çš„å†…å®¹ï¼šç›´æ¥ä½¿ç”¨å¹²å‡€çš„æ ‡ç­¾å’Œæ¢è¡Œç¬¦ï¼Œä¸å¤ç”¨æ—§å†…å®¹
              new_block = f"{START_TAG}\nğŸ•’ æœ¬é¡¹ç›®æœ€è¿‘æ›´æ–°äºï¼š{time_std}\n{END_TAG}"
              
              # æ‰§è¡Œæ›¿æ¢
              new_content = re.sub(pattern, new_block, content, flags=re.DOTALL)
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(new_content)
              print("âœ… README ä¿®æ”¹æˆåŠŸ (å·²é‡ç½®æ ‡ç­¾å’Œç¼–ç )")
              
          except Exception as e:
              print(f"âŒ ä¿®æ”¹ README å¤±è´¥: {e}")
              exit(1)
          EOF

      # ğŸŸ¢ ç¬¬äºŒæ­¥ï¼šæäº¤æ›´æ”¹
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n $(git status -s) ]]; then
            git add README.md
            git commit -m "docs: fix encoding and update time [skip ci]"
            git push
            echo "ğŸ‰ æˆåŠŸæ¨é€åˆ° GitHub"
          else
            echo "âš ï¸ æ²¡æœ‰æ–‡ä»¶å˜åŒ–"
          fi

      # ğŸŸ¢ ç¬¬ä¸‰æ­¥ï¼šç¼–è¾‘ Telegram æ¶ˆæ¯
      - name: Edit Telegram Message
        env:
          TG_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHANNEL_ID }}
          TG_MSG_ID: ${{ secrets.TG_MESSAGE_ID }}
          UPDATE_TIME: ${{ env.UPDATE_TIME_CN }}
          ICON_COUNT: ${{ env.ICON_COUNT }}
          
          # ğŸ‘‡ æ–‡æ¡ˆæ¨¡æ¿
          MESSAGE_TEMPLATE: |
            <b>ä¸ºäº†å‡å°‘æ›´æ–°æ—¥å¿—æ¯æ¬¡æ¶ˆæ¯çš„å†…å®¹ç¯‡å¹…ï¼Œä»¥åæ›´æ–°æ—¥å¿—åªå†™æ›´æ–°çš„å†…å®¹ï¼Œå›¾æ ‡é“¾æ¥ç­‰ä¼šåœ¨è¯¥æ¶ˆæ¯æä¾›ã€‚è¯¥æ¶ˆæ¯ä¼šé•¿æœŸç½®é¡¶ã€‚</b>
            
            å›¾æ ‡æ’åºä¸ºï¼šå›½æ——  ä»£ç†è½¯ä»¶logo  å›½å†…å¯ç›´è¿è½¯ä»¶å›¾æ ‡  å¤–ç½‘è½¯ä»¶å›¾æ ‡  æ— åˆ†ç±»çš„å›¾æ ‡ æœºåœºlogo
            
            å¤åˆ¶ä»¥ä¸‹å›¾æ ‡åº“é“¾æ¥å¯¼å…¥å³å¯( æ­¤å›¾æ ‡åŒ…ä¸åŒ…å«Embyæœå›¾æ ‡ï¼ŒEmbyå›¾æ ‡è¯·å¯¼å…¥ä¸‹é¢çš„é‚£ä¸ª)
            <a href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json">https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json</a>
            
            <a href="https://quantumult.app/x/open-app/ui?module=gallery&type=icon&action=add&content=%5B%22https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json%22%5D">QuantumultXä¸€é”®å¯¼å…¥</a>
            <a href="https://www.nsloon.com/openloon/import?iconset=https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json">Loonä¸€é”®å¯¼å…¥</a>
            
            Surgeå›¾æ ‡åº“é“¾æ¥ï¼š
            <a href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon-surge.json">https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon-surge.json</a>
            
            Embyå›¾æ ‡åº“ï¼ˆåªæœ‰Embyå›¾æ ‡ï¼Œå»ºè®® Fileball Senplayer Yamby Hills Forward å°å¹»å½±è§† ä½¿ç”¨ï¼‰
            <a href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/refs/heads/main/lige-emby-icon.json">https://raw.githubusercontent.com/lige47/QuanX-icon-rule/refs/heads/main/lige-emby-icon.json</a>
            
            æœ¬é¢‘é“é“¾æ¥ï¼š<a href="https://t.me/ligeicon">https://t.me/ligeicon</a>   ç¾¤ç»„ï¼š<a href="https://t.me/ligeicon_group">https://t.me/ligeicon_group</a>
            éœ€è¦é€‚é…å›¾æ ‡ç¾¤å†…åé¦ˆå³å¯ã€‚æ— å¿é€‚é…ï¼ï¼ï¼
            
            ä¸€äº›å°çš„æ–°å¢å¯èƒ½ä¸ä¼šå‘é¢‘é“ï¼Œå¯ä»¥å…³æ³¨è¿™ä¸ªæœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ï¼Œæ¥åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æœ€æ–°çš„åº“ã€‚
            Githubåœ°å€ï¼š
            <a href="https://github.com/lige47/QuanX-icon-rule">https://github.com/lige47/QuanX-icon-rule</a>
            <b>æœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ä¸ºï¼š{time}  ç›®å‰å›¾æ ‡æ•°ä¸º{count}ä¸ªï¼</b>
            
            è‡ªè¥æ­£è§„æµé‡å¡ï¼š
            <a href="https://lc.189sd.cn/index?k=WFpJYmVSWnFjTFk9">189å¡ä¸š</a>  <a href="https://h5.gantanhao.com/url?value=pVC7v1759672595456">å¡ä¸šè”ç›Ÿ</a>
            æœ‰ä»»ä½•æµé‡å¡é—®é¢˜è”ç³»ï¼š @lige0407_bot

        run: |
          python3 - <<EOF
          import os
          import json
          import urllib.request

          token = os.environ.get('TG_TOKEN')
          chat_id = os.environ.get('TG_CHAT_ID')
          msg_id = os.environ.get('TG_MSG_ID')
          template = os.environ.get('MESSAGE_TEMPLATE')
          time_str = os.environ.get('UPDATE_TIME')
          count_str = os.environ.get('ICON_COUNT')

          if not all([token, chat_id, msg_id, template]):
              print("Error: ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡")
              exit(1)

          final_text = template.replace('{time}', time_str).replace('{count}', count_str)

          data = {
              "chat_id": chat_id,
              "message_id": msg_id,
              "text": final_text,
              "parse_mode": "HTML",
              "disable_web_page_preview": True
          }

          url = f"https://api.telegram.org/bot{token}/editMessageText"
          headers = {'Content-Type': 'application/json'}
          
          try:
              req = urllib.request.Request(url, data=json.dumps(data).encode('utf-8'), headers=headers, method='POST')
              with urllib.request.urlopen(req) as response:
                  print("âœ… æ¶ˆæ¯ç¼–è¾‘æˆåŠŸ:", response.read().decode('utf-8'))
          except Exception as e:
              print(f"âŒ å‘é€å¤±è´¥: {e}")
              exit(1)
          EOF
