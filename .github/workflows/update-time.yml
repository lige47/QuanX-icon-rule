name: Update Icons and README Time

on:
  push:
    paths:
      - 'icon/**'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # ğŸŸ¢ ç¬¬ä¸€æ­¥ï¼šè¿è¡Œå›¾æ ‡ç”Ÿæˆè„šæœ¬
      - name: Run Update Icons Script
        run: python scripts/update_icons.py

      # ğŸŸ¢ ç¬¬äºŒæ­¥ï¼šä½¿ç”¨ Python ç»Ÿä¸€å¤„ç† README å’Œ TG æ¶ˆæ¯
      - name: Calculate Data, Update README & TG
        id: update_step
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
        shell: python
        run: |
          import os
          import re
          import json
          import urllib.parse
          import urllib.request
          from datetime import datetime, timedelta

          # 1. è®¡ç®—æ—¶é—´ (åŒ—äº¬æ—¶é—´)
          now_beijing = datetime.utcnow() + timedelta(hours=8)
          time_std = now_beijing.strftime('%Y-%m-%d %H:%M:%S')
          time_cn = now_beijing.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')

          # 2. è¯»å–æœ€æ–°ç”Ÿæˆçš„å›¾æ ‡æ€»æ•°
          icon_count = 0
          try:
              with open('lige-emby-icon.json', 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  icon_count = len(data.get('icons', []))
          except: pass

          # 3. ä¿®æ”¹ README.md (è§£å†³é‡å¤è¡Œé—®é¢˜)
          try:
              with open('README.md', 'r', encoding='utf-8') as f:
                  content = f.read()
              
              new_line = f"ğŸ•’ æœ¬é¡¹ç›®æœ€è¿‘æ›´æ–°äºï¼š{time_std} (å…±è®¡ {icon_count} ä¸ªå›¾æ ‡)"
              
              # ã€é˜²å‘†é€»è¾‘ã€‘å…ˆåˆ æ‰æ‰€æœ‰å·²å­˜åœ¨çš„æ›´æ–°æ—¶é—´è¡Œï¼ˆæ¸…ç†ä¹‹å‰æŠ¥é”™äº§ç”Ÿçš„é‡å¤è¡Œï¼‰
              content = re.sub(r"ğŸ•’ æœ¬é¡¹ç›®æœ€è¿‘æ›´æ–°äºï¼š.*?\n?", "", content)
              # åœ¨â€œé¡¹ç›®ç®€ä»‹â€è¿™å››ä¸ªå­—å‰é¢æ’å…¥æ–°çš„ä¸€è¡Œ
              content = content.replace("é¡¹ç›®ç®€ä»‹", f"{new_line}\né¡¹ç›®ç®€ä»‹", 1)
              
              with open('README.md', 'w', encoding='utf-8') as f:
                  f.write(content)
              print("âœ… README æ¸…ç†å¹¶æ›´æ–°æˆåŠŸ")
          except Exception as e:
              print(f"âŒ README ä¿®æ”¹å¤±è´¥: {e}")

          # 4. ä¿®æ”¹ Telegram æ¶ˆæ¯ (ä½¿ç”¨ä½ æä¾›çš„å®Œæ•´æ¨¡æ¿)
          token = os.environ.get('TG_BOT_TOKEN')
          chat_id = "@ligeicon"
          msg_id = "91"
          
          # è¿™é‡Œæ˜¯ä½ æä¾›çš„å®Œæ•´åŸå§‹æ¶ˆæ¯æ¨¡æ¿ï¼Œä¸­é—´ç”¨ {time_cn} å’Œ {icon_count} å ä½
          tg_template = """ä¸ºäº†å‡å°‘æ›´æ–°æ—¥å¿—æ¯æ¬¡æ¶ˆæ¯çš„å†…å®¹ç¯‡å¹…ï¼Œä»¥åæ›´æ–°æ—¥å¿—åªå†™æ›´æ–°çš„å†…å®¹ï¼Œå›¾æ ‡é“¾æ¥ç­‰ä¼šåœ¨è¯¥æ¶ˆæ¯æä¾›ã€‚è¯¥æ¶ˆæ¯ä¼šé•¿æœŸç½®é¡¶ã€‚

å›¾æ ‡æ’åºä¸ºï¼šå›½æ——  ä»£ç†è½¯ä»¶logo  å›½å†…å¯ç›´è¿è½¯ä»¶å›¾æ ‡  å¤–ç½‘è½¯ä»¶å›¾æ ‡  æ— åˆ†ç±»çš„å›¾æ ‡ æœºåœºlogo

å¤åˆ¶ä»¥ä¸‹å›¾æ ‡åº“é“¾æ¥å¯¼å…¥å³å¯( æ­¤å›¾æ ‡åŒ…ä¸åŒ…å«Embyæœå›¾æ ‡ï¼ŒEmbyå›¾æ ‡è¯·å¯¼å…¥ä¸‹é¢çš„é‚£ä¸ª)
https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json

QuantumultXä¸€é”®å¯¼å…¥ (https://quantumult.app/x/open-app/ui?module=gallery&type=icon&action=add&content=%5B%22https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json%22%5D)
Loonä¸€é”®å¯¼å…¥ (https://www.nsloon.com/openloon/import?iconset=https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json)

Surgeå›¾æ ‡åº“é“¾æ¥ï¼š
https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon-surge.json

Embyå›¾æ ‡åº“ï¼ˆåªæœ‰Embyå›¾æ ‡ï¼Œå»ºè®® Fileball Senplayer Yamby Hills Forward å°å¹»å½±è§† ä½¿ç”¨ï¼‰
https://raw.githubusercontent.com/lige47/QuanX-icon-rule/refs/heads/main/lige-emby-icon.json

æœ¬é¢‘é“é“¾æ¥ï¼šhttps://t.me/ligeicon    ç¾¤ç»„ï¼šhttps://t.me/ligeicon_group
éœ€è¦é€‚é…å›¾æ ‡ç¾¤å†…åé¦ˆå³å¯ã€‚æ— å¿é€‚é…ï¼ï¼ï¼

ä¸€äº›å°çš„æ–°å¢å¯èƒ½ä¸ä¼šå‘é¢‘é“ï¼Œå¯ä»¥å…³æ³¨è¿™ä¸ªæœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ï¼Œæ¥åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æœ€æ–°çš„åº“ã€‚
Githubåœ°å€ï¼š
https://github.com/lige47/QuanX-icon-rule
æœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ä¸ºï¼š{time_cn}  ç›®å‰å›¾æ ‡æ•°ä¸º{icon_count}ä¸ªï¼

è‡ªè¥æ­£è§„æµé‡å¡ï¼š
189å¡ä¸š (https://lc.189sd.cn/index?k=WFpJYmVSWnFjTFk9)  å¡ä¸šè”ç›Ÿ (https://h5.gantanhao.com/url?value=pVC7v1759672595456)
æœ‰ä»»ä½•æµé‡å¡é—®é¢˜è”ç³»ï¼š @lige0407_bot"""

          final_text = tg_template.format(time_cn=time_cn, icon_count=icon_count)

          try:
              url = f"https://api.telegram.org/bot{token}/editMessageText"
              params = urllib.parse.urlencode({
                  "chat_id": chat_id,
                  "message_id": msg_id,
                  "text": final_text,
                  "disable_web_page_preview": "true" # ä¿æŒæ¶ˆæ¯æ•´æ´ï¼Œä¸ç”Ÿæˆä¸€å †ç½‘é¡µé¢„è§ˆ
              }).encode("utf-8")
              
              req = urllib.request.Request(url, data=params)
              with urllib.request.urlopen(req) as response:
                  print(f"âœ… TG æ¶ˆæ¯æ›´æ–°æˆåŠŸ: {response.read().decode()}")
          except Exception as e:
              print(f"âŒ TG æ¶ˆæ¯æ›´æ–°å¤±è´¥: {e}")

      # ğŸŸ¢ ç¬¬ä¸‰æ­¥ï¼šæ¨é€å˜åŠ¨åˆ° GitHub
      - name: Commit and Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .
          if [[ -n $(git status -s) ]]; then
            git commit -m "auto: cleanup and update stats [skip ci]"
            git push
          fi
