name: Update Last Updated Time

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Update time in README
        id: date_step
        run: |
          # ç”Ÿæˆä¸­æ–‡æ ¼å¼æ—¶é—´ (ç”¨äº Telegram)
          TIME_CN=$(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
          echo "UPDATE_TIME_CN=$TIME_CN" >> $GITHUB_ENV
          
          # ç”Ÿæˆæ ‡å‡†æ ¼å¼æ—¶é—´ (ç”¨äº README)
          TIME_STD=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
          
          # ä¿®æ”¹ README
          sed -i "s/<!-- START_SECTION:update_time -->.*<!-- END_SECTION:update_time -->/<!-- START_SECTION:update_time -->\nğŸ•’ æœ¬é¡¹ç›®æœ€è¿‘æ›´æ–°äºï¼š$TIME_STD\n<!-- END_SECTION:update_time -->/g" README.md || true

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [[ -n $(git status -s) ]]; then
            git add README.md
            git commit -m "docs: auto update last updated time [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi

      # ã€å®Œç¾ä¿®å¤ç‰ˆã€‘ä½¿ç”¨ Python å‘é€è¯·æ±‚ï¼Œè‡ªåŠ¨å¤„ç†æ¢è¡Œå’Œç¬¦å·
      - name: Edit Telegram Message
        env:
          TG_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHANNEL_ID }}
          TG_MSG_ID: ${{ secrets.TG_MESSAGE_ID }}
          UPDATE_TIME: ${{ env.UPDATE_TIME_CN }}
          
          # ğŸ‘‡ æ–‡æ¡ˆæ¨¡æ¿ (åœ¨è¿™é‡Œç›´æ¥ä¿®æ”¹ï¼Œæ‰€è§å³æ‰€å¾—)
          MESSAGE_TEMPLATE: |
            <b>ä¸ºäº†å‡å°‘æ›´æ–°æ—¥å¿—æ¯æ¬¡æ¶ˆæ¯çš„å†…å®¹ç¯‡å¹…ï¼Œä»¥åæ›´æ–°æ—¥å¿—åªå†™æ›´æ–°çš„å†…å®¹ï¼Œå›¾æ ‡é“¾æ¥ç­‰ä¼šåœ¨è¯¥æ¶ˆæ¯æä¾›ã€‚è¯¥æ¶ˆæ¯ä¼šé•¿æœŸç½®é¡¶ã€‚</b>
            
            å›¾æ ‡æ’åºä¸ºï¼šå›½æ——  ä»£ç†è½¯ä»¶logo  å›½å†…å¯ç›´è¿è½¯ä»¶å›¾æ ‡  å¤–ç½‘è½¯ä»¶å›¾æ ‡  æ— åˆ†ç±»çš„å›¾æ ‡ æœºåœºlogo
            
            å¤åˆ¶ä»¥ä¸‹å›¾æ ‡åº“é“¾æ¥å¯¼å…¥å³å¯( æ­¤å›¾æ ‡åŒ…ä¸åŒ…å«Embyæœå›¾æ ‡ï¼ŒEmbyå›¾æ ‡è¯·å¯¼å…¥ä¸‹é¢çš„é‚£ä¸ª)
            <a href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json">https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json</a>
            
            <a href="https://quantumult.app/x/open-app/ui?module=gallery&type=icon&action=add&content=%5B%22https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json%22%5D">QuantumultXä¸€é”®å¯¼å…¥</a>
            <a href="https://www.nsloon.com/openloon/import?iconset=https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon.json">Loonä¸€é”®å¯¼å…¥</a>
            
            Surgeå›¾æ ‡åº“é“¾æ¥ï¼š
            <a href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon-surge.json">https://raw.githubusercontent.com/lige47/QuanX-icon-rule/main/ligeicon-surge.json</a>
            
            Embyå›¾æ ‡åº“ï¼ˆåªæœ‰Embyå›¾æ ‡ï¼Œå»ºè®® Fileball Senplayer Yamby Hills Forward å°å¹»å½±è§† ä½¿ç”¨ï¼‰
            <a href="https://raw.githubusercontent.com/lige47/QuanX-icon-rule/refs/heads/main/lige-emby-icon.json">https://raw.githubusercontent.com/lige47/QuanX-icon-rule/refs/heads/main/lige-emby-icon.json</a>
            
            æœ¬é¢‘é“é“¾æ¥ï¼š<a href="https://t.me/ligeicon">https://t.me/ligeicon</a>   ç¾¤ç»„ï¼š<a href="https://t.me/ligeicon_group">https://t.me/ligeicon_group</a>
            éœ€è¦é€‚é…å›¾æ ‡ç¾¤å†…åé¦ˆå³å¯ã€‚æ— å¿é€‚é…ï¼ï¼ï¼
            
            ä¸€äº›å°çš„æ–°å¢å¯èƒ½ä¸ä¼šå‘é¢‘é“ï¼Œå¯ä»¥å…³æ³¨è¿™ä¸ªæœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ï¼Œæ¥åˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æœ€æ–°çš„åº“ã€‚
            Githubåœ°å€ï¼š
            <a href="https://github.com/lige47/QuanX-icon-rule">https://github.com/lige47/QuanX-icon-rule</a>
            æœ€è¿‘ä¸€æ¬¡æ›´æ–°æ—¶é—´ä¸ºï¼š{time}  ç›®å‰å›¾æ ‡æ•°ä¸º986ä¸ªï¼ç‰ˆæœ¬å· 251120
            
            è‡ªè¥æ­£è§„æµé‡å¡ï¼š
            <a href="https://lc.189sd.cn/index?k=WFpJYmVSWnFjTFk9">189å¡ä¸š</a>  <a href="https://h5.gantanhao.com/url?value=pVC7v1759672595456">å¡ä¸šè”ç›Ÿ</a>
            æœ‰ä»»ä½•æµé‡å¡é—®é¢˜è”ç³»ï¼š @lige0407_bot

        run: |
          python3 - <<EOF
          import os
          import json
          import urllib.request

          # 1. è·å–ç¯å¢ƒå˜é‡
          token = os.environ.get('TG_TOKEN')
          chat_id = os.environ.get('TG_CHAT_ID')
          msg_id = os.environ.get('TG_MSG_ID')
          template = os.environ.get('MESSAGE_TEMPLATE')
          time_str = os.environ.get('UPDATE_TIME')

          if not all([token, chat_id, msg_id, template]):
              print("Error: ç¼ºå°‘å¿…è¦çš„ç¯å¢ƒå˜é‡")
              exit(1)

          # 2. æ›¿æ¢æ—¶é—´å ä½ç¬¦
          final_text = template.replace('{time}', time_str)

          # 3. æ„å»º JSON æ•°æ® (Python ä¼šè‡ªåŠ¨å¤„ç†è½¬ä¹‰å’Œæ¢è¡Œï¼Œæœ€å®‰å…¨)
          data = {
              "chat_id": chat_id,
              "message_id": msg_id,
              "text": final_text,
              "parse_mode": "HTML",
              "disable_web_page_preview": True
          }

          # 4. å‘é€è¯·æ±‚
          url = f"https://api.telegram.org/bot{token}/editMessageText"
          headers = {'Content-Type': 'application/json'}
          
          try:
              req = urllib.request.Request(url, data=json.dumps(data).encode('utf-8'), headers=headers, method='POST')
              with urllib.request.urlopen(req) as response:
                  print("âœ… æ¶ˆæ¯ç¼–è¾‘æˆåŠŸ:", response.read().decode('utf-8'))
          except urllib.error.HTTPError as e:
              print(f"âŒ å‘é€å¤±è´¥: {e.code} {e.reason}")
              print(e.read().decode('utf-8'))
              exit(1)
          except Exception as e:
              print(f"âŒ å‘ç”Ÿé”™è¯¯: {e}")
              exit(1)
          EOF
